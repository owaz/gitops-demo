name: Provision application from Port

on:
  repository_dispatch:
    types:
      - port-provision-application

permissions:
  contents: write

jobs:
  provision:
    runs-on: ubuntu-latest
    env:
      APP_NAME: ${{ github.event.client_payload.appName }}
      TEAM_NAME: ${{ github.event.client_payload.team }}
      INGRESS_HOST: ${{ github.event.client_payload.ingressHost }}
      TEMPLATE_DIR: ${{ github.event.client_payload.templateSource }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Render application templates
        run: |
          set -euo pipefail

          if [ -z "${TEMPLATE_DIR}" ]; then
            TEMPLATE_DIR="applications/_templates/app"
          fi

          DEST_DIR="applications/${TEAM_NAME}/${APP_NAME}"
          mkdir -p "${DEST_DIR}"

          for template in deployment.yaml service.yaml ingress.yaml; do
            envsubst < "${TEMPLATE_DIR}/${template}" > "${DEST_DIR}/${template}"
          done

      - name: Commit and push changes
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "applications/${TEAM_NAME}/${APP_NAME}"
          git commit -m "Provision application ${TEAM_NAME}/${APP_NAME}"
          git push origin HEAD
