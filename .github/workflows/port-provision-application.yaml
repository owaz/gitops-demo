name: Provision application from Port

on:
  workflow_dispatch:
    inputs:
      appName:
        description: 'Application name'
        required: true
        type: string
      team:
        description: 'Team name'
        required: true
        type: string
      ingressHost:
        description: 'Ingress host'
        required: false
        type: string
      port_context:
        description: 'Port context (Portal metadata)'
        required: false
        type: string
  repository_dispatch:
    types:
      - port-provision-application

permissions:
  contents: write

jobs:
  provision:
    runs-on: ubuntu-latest
    env:
      APP_NAME: ${{ github.event.inputs.appName || github.event.client_payload.appName }}
      TEAM_NAME: ${{ github.event.inputs.team || github.event.client_payload.team }}
      INGRESS_HOST: ${{ github.event.inputs.ingressHost || github.event.client_payload.ingressHost }}
      TEMPLATE_DIR: applications/_templates/app
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Render application templates
        run: |
          set -euo pipefail

          NAMESPACE_MANIFEST="platform/namespaces/app-${TEAM_NAME}.yaml"
          if [ ! -f "${NAMESPACE_MANIFEST}" ]; then
            TEAM_LABEL="${TEAM_NAME#team-}"
            cat <<EOF | sed 's/^          //' > "${NAMESPACE_MANIFEST}"
          apiVersion: v1
          kind: Namespace
          metadata:
            name: ${TEAM_NAME}
            labels:
              team: ${TEAM_LABEL}
              managed-by: platform-team
          ---
          apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: ${TEAM_NAME}-quota
            namespace: ${TEAM_NAME}
          spec:
            hard:
              requests.cpu: "4"
              requests.memory: 8Gi
              limits.cpu: "8"
              limits.memory: 16Gi
              pods: "20"
              services: "10"
          ---
          apiVersion: v1
          kind: LimitRange
          metadata:
            name: ${TEAM_NAME}-limits
            namespace: ${TEAM_NAME}
          spec:
            limits:
              - default:
                  cpu: 500m
                  memory: 512Mi
                defaultRequest:
                  cpu: 100m
                  memory: 128Mi
                type: Container
          EOF
          fi

          DEST_DIR="applications/${TEAM_NAME}/${APP_NAME}"
          mkdir -p "${DEST_DIR}"

          for template in deployment.yaml service.yaml ingress.yaml; do
            envsubst < "${TEMPLATE_DIR}/${template}" > "${DEST_DIR}/${template}"
          done

      - name: Commit and push changes
        run: |
          set -euo pipefail

          git add "applications/${TEAM_NAME}/${APP_NAME}"
          if [ -f "platform/namespaces/app-${TEAM_NAME}.yaml" ]; then
            git add "platform/namespaces/app-${TEAM_NAME}.yaml"
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Provision application ${TEAM_NAME}/${APP_NAME}"
          git push origin HEAD

      - name: Report success to Port
        if: success() && github.event.inputs.port_context != ''
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).run.id }}
          status: "SUCCESS"
          logMessage: |
            ✅ Application provisioned successfully!
            - Team: ${{ github.event.inputs.team }}
            - App: ${{ github.event.inputs.appName }}
            - Path: applications/${{ github.event.inputs.team }}/${{ github.event.inputs.appName }}

      - name: Report failure to Port
        if: failure() && github.event.inputs.port_context != ''
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).run.id }}
          status: "FAILURE"
          logMessage: "❌ Provisioning failed. Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
