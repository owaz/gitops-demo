name: Provision application from Port

on:
  workflow_dispatch:
    inputs:
      appName:
        description: 'Application name'
        required: true
        type: string
      team:
        description: 'Team name'
        required: true
        type: string
      ingressHost:
        description: 'Ingress host'
        required: false
        type: string
      port_context:
        description: 'Port context (Portal metadata)'
        required: false
        type: string
  repository_dispatch:
    types:
      - port-provision-application

permissions:
  contents: write
  pull-requests: write

jobs:
  provision:
    runs-on: ubuntu-latest
    env:
      APP_NAME: ${{ github.event.inputs.appName || github.event.client_payload.appName }}
      TEAM_NAME: ${{ github.event.inputs.team || github.event.client_payload.team }}
      INGRESS_HOST: ${{ github.event.inputs.ingressHost || github.event.client_payload.ingressHost }}
      TEMPLATE_DIR: applications/_templates/app
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Render application templates
        run: |
          set -euo pipefail

          # Generate a 3-letter random suffix for globally unique storage account name
          export STORAGE_SUFFIX=$(head /dev/urandom | tr -dc 'a-z0-9' | head -c 3)

          NAMESPACE_MANIFEST="platform/namespaces/app-${TEAM_NAME}.yaml"
          if [ ! -f "${NAMESPACE_MANIFEST}" ]; then
            TEAM_LABEL="${TEAM_NAME#team-}"
            cat <<EOF | sed 's/^          //' > "${NAMESPACE_MANIFEST}"
          apiVersion: v1
          kind: Namespace
          metadata:
            name: ${TEAM_NAME}
            labels:
              team: ${TEAM_LABEL}
              managed-by: platform-team
          ---
          apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: ${TEAM_NAME}-quota
            namespace: ${TEAM_NAME}
          spec:
            hard:
              requests.cpu: "4"
              requests.memory: 8Gi
              limits.cpu: "8"
              limits.memory: 16Gi
              pods: "20"
              services: "10"
          ---
          apiVersion: v1
          kind: LimitRange
          metadata:
            name: ${TEAM_NAME}-limits
            namespace: ${TEAM_NAME}
          spec:
            limits:
              - default:
                  cpu: 500m
                  memory: 512Mi
                defaultRequest:
                  cpu: 100m
                  memory: 128Mi
                type: Container
          EOF
          fi

          DEST_DIR="applications/${TEAM_NAME}/${APP_NAME}"
          mkdir -p "${DEST_DIR}"

          for template in deployment.yaml service.yaml ingress.yaml resourcegroup.yaml storageaccount.yaml; do
            envsubst < "${TEMPLATE_DIR}/${template}" > "${DEST_DIR}/${template}"
          done

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Provision application ${{ env.TEAM_NAME }}/${{ env.APP_NAME }}"
          branch: "provision/${{ env.TEAM_NAME }}-${{ env.APP_NAME }}-${{ github.run_id }}"
          delete-branch: true
          title: "üöÄ Provision application: ${{ env.TEAM_NAME }}/${{ env.APP_NAME }}"
          body: |
            ## Application Provisioning Request

            This PR was automatically created to provision a new application.

            | Property | Value |
            |----------|-------|
            | **Team** | `${{ env.TEAM_NAME }}` |
            | **Application** | `${{ env.APP_NAME }}` |
            | **Ingress Host** | `${{ env.INGRESS_HOST }}` |

            ### Files Created
            - `applications/${{ env.TEAM_NAME }}/${{ env.APP_NAME }}/deployment.yaml`
            - `applications/${{ env.TEAM_NAME }}/${{ env.APP_NAME }}/service.yaml`
            - `applications/${{ env.TEAM_NAME }}/${{ env.APP_NAME }}/ingress.yaml`
            - `applications/${{ env.TEAM_NAME }}/${{ env.APP_NAME }}/resourcegroup.yaml`
            - `applications/${{ env.TEAM_NAME }}/${{ env.APP_NAME }}/storageaccount.yaml`

            ### Review Checklist
            - [ ] Resource configurations are correct
            - [ ] Ingress host is valid
            - [ ] Team namespace exists or will be created

            ---
            *Triggered by GitHub Actions run [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          labels: |
            provisioning
            automated
          assignees: ${{ github.actor }}

      - name: Report success to Port
        if: success() && steps.create-pr.outputs.pull-request-number
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          status: "SUCCESS"
          logMessage: |
            ‚úÖ Pull Request created for review!
            - Team: ${{ env.TEAM_NAME }}
            - App: ${{ env.APP_NAME }}
            - PR: ${{ steps.create-pr.outputs.pull-request-url }}
            
            Please review and merge the PR to complete provisioning.

      - name: Report failure to Port
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          status: "FAILURE"
          logMessage: "‚ùå Provisioning failed. Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
